# name: test/sql/faiss.test
# description: test faiss extension
# group: [faiss]

require faiss

statement ok
CALL faiss_create('flat82', 8, 'IDMap,Flat');

statement ok
create table vectors as SELECT column0 lbl, list_value(column1, column2, column3, column4, column5, column6, column7, column8) emb FROM 'test/sql/training.csv'


statement ok
CALL faiss_add((SELECT lbl, emb FROM vectors), 'flat82')

query II
WITH
queries AS (SELECT list_value(column1, column2, column3, column4, column5, column6, column7, column8) emb FROM 'test/sql/queries.csv'),
labels AS (SELECT UNNEST(faiss_search('flat82', 2, emb)).label lbl FROM queries)
SELECT * FROM labels JOIN vectors USING(lbl)
----
59 	[0.94394267, 0.59308696, 0.08621723, 0.92487592, 0.91371959, 0.98075676, 0.90002209, 0.9497146]
374	[1.22999454, 0.87794572, 0.85353756, 0.90218973, 0.87004632, 0.89970881, 0.73028845, 0.83116871]
623	[1.20391214, 0.81502259, 0.92808086, 0.83055145, 0.81303358, 0.76485956, 0.94660473, 0.58263487]
676	[1.19281077, 0.78318536, 0.90775794, 0.92996532, 0.43454993, 0.78495824, 0.80674958, 0.80477083]
768	[1.65519321, 0.87163031, 0.9222675, 0.81811273, 0.91960794, 0.35215199, 0.5803771, 0.68664783]
880	[1.82449365, 0.38700503, 0.36764321, 0.7872318, 0.92854214, 0.81106687, 0.72996461, 0.88329279]
904	[1.83665156, 0.20765415, 0.80885243, 0.12091811, 0.88081354, 0.83096611, 0.77531248, 0.00983775]
943	[1.71095765, 0.73801923, 0.96433401, 0.46091145, 0.01990139, 0.97149271, 0.92068374, 0.57211047]
955	[1.84238648, 0.23969825, 0.47329777, 0.67880243, 0.41431817, 0.64999616, 0.99049366, 0.97541863]
999	[1.68301702, 0.7870456, 0.90561724, 0.08606782, 0.83585393, 0.92503619, 0.83019149, 0.47703925]
59 	[0.94394267, 0.59308696, 0.08621723, 0.92487592, 0.91371959, 0.98075676, 0.90002209, 0.9497146]
374	[1.22999454, 0.87794572, 0.85353756, 0.90218973, 0.87004632, 0.89970881, 0.73028845, 0.83116871]
623	[1.20391214, 0.81502259, 0.92808086, 0.83055145, 0.81303358, 0.76485956, 0.94660473, 0.58263487]
676	[1.19281077, 0.78318536, 0.90775794, 0.92996532, 0.43454993, 0.78495824, 0.80674958, 0.80477083]
880	[1.82449365, 0.38700503, 0.36764321, 0.7872318, 0.92854214, 0.81106687, 0.72996461, 0.88329279]
374	[1.22999454, 0.87794572, 0.85353756, 0.90218973, 0.87004632, 0.89970881, 0.73028845, 0.83116871]
880	[1.82449365, 0.38700503, 0.36764321, 0.7872318, 0.92854214, 0.81106687, 0.72996461, 0.88329279]
374	[1.22999454, 0.87794572, 0.85353756, 0.90218973, 0.87004632, 0.89970881, 0.73028845, 0.83116871]
374	[1.22999454, 0.87794572, 0.85353756, 0.90218973, 0.87004632, 0.89970881, 0.73028845, 0.83116871]
374	[1.22999454, 0.87794572, 0.85353756, 0.90218973, 0.87004632, 0.89970881, 0.73028845, 0.83116871]

statement ok
CALL faiss_destroy('flat82');